FROM ubuntu

ARG DEBIAN_FRONTEND=noninteractive
ARG TZ=Asia/Tokyo
ENV TZ=${TZ}

ARG USERNAME=foo
ARG UID=1000

RUN apt-get update \
 && apt-get -y upgrade \
 && apt-get -y install git wget sudo vim systemctl \
 && apt-get -y install gcc make \
 && apt-get -y install libssl-dev libpq-dev \
 && apt-get -y install libglobus-gssapi-gsi-dev pkgconf \
 && apt-get -y install libibverbs-dev \
 && apt-get -y install postgresql postgresql-client \
 && apt-get -y install python3 ruby \
 && apt-get -y install python3-docopt python3-schema python3-tqdm \
 && apt-get -y install fuse libfuse-dev libacl1-dev \
 && apt-get -y install gdb \
 && apt-get -y install myproxy globus-simple-ca

RUN \
  # sshd
  apt-get -y install --no-install-recommends \
    openssh-server \
  # sshd_config
  && printf '%s\n' \
    'PasswordAuthentication yes' \
    'PermitEmptyPasswords yes' \
    'UsePAM no' \
    > /etc/ssh/sshd_config.d/auth.conf \
  # ssh_config
  && printf '%s\n' \
    'Host *' \
    '    StrictHostKeyChecking no' \
    > /etc/ssh/ssh_config.d/ignore-host-key.conf

RUN useradd -m -u $UID -s /bin/bash $USERNAME \
 && echo "$USERNAME ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers.d/$USERNAME \
 # delete passwd
 && passwd -d $USERNAME

RUN mv /usr/bin/grid-cert-request /usr/bin/grid-cert-request.orig \
 && sed 's/:\/var\/adm\/wtmp:\/var\/log\/messages//' \
      /usr/bin/grid-cert-request.orig > /usr/bin/grid-cert-request \
 && chmod +x /usr/bin/grid-cert-request

RUN useradd -m _gfarmfs \
 && useradd -m _gfarmmd

USER $USERNAME
RUN cd \
 && mkdir local

USER root
CMD service ssh start && sleep infinity
