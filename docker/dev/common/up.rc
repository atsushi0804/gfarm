set -eux

: $GFDOCKER_NUM_GFMDS
: $GFDOCKER_NUM_GFSDS
: $GFDOCKER_NUM_CLIENTS
: $GFDOCKER_HOSTNAME_PREFIX_GFMD
: $GFDOCKER_HOSTNAME_PREFIX_GFSD
: $GFDOCKER_HOSTNAME_PREFIX_CLIENT

gfmds=
gfsds=
clients=

for i in $(seq 1 $GFDOCKER_NUM_GFMDS); do
  gfmds="${gfmds} ${GFDOCKER_HOSTNAME_PREFIX_GFMD}${i}"
done
for i in $(seq 1 $GFDOCKER_NUM_GFSDS); do
  gfsds="${gfsds} ${GFDOCKER_HOSTNAME_PREFIX_GFSD}${i}"
done
for i in $(seq 1 $GFDOCKER_NUM_CLIENTS); do
  clients="${clients} ${GFDOCKER_HOSTNAME_PREFIX_CLIENT}${i}"
done

# keep ssh keys only for user1@client1

MNT=/mnt
MNT_SSH_HOST_KEY_DIR=${MNT}/ssh_host_keys
MNT_SSH_AUTHORIZED_KEYS_FILE=${MNT}/ssh_authorized_keys
HOST_KEY_DIR=/etc/ssh
SSH_AUTHORIZED_KEYS_FILE=~user1/.ssh/authorized_keys

if [ ! -d $MNT_SSH_HOST_KEY_DIR ]; then
  sudo mkdir $MNT_SSH_HOST_KEY_DIR
fi
for f in $(echo $MNT_SSH_HOST_KEY_DIR/ssh_host_*_key); do
  if [ -f "$f" ]; then
    sudo cp -p "$f" $HOST_KEY_DIR/
  fi
done
sudo systemctl restart sshd

SAVE_KEYS_SCRIPT=~user1/SAVE_SSH_HOST_KEYS.sh
cat << EOF > $SAVE_KEYS_SCRIPT
cp -a /etc/ssh/ssh_host_*_key /mnt/ssh_host_keys/
EOF
chmod +x $SAVE_KEYS_SCRIPT

if [ -f $MNT_SSH_AUTHORIZED_KEYS_FILE ]; then
  cat $MNT_SSH_AUTHORIZED_KEYS_FILE >> $SSH_AUTHORIZED_KEYS_FILE
fi

ssh_retry() {
  host="$1"
  retry_sec=30
  for i in $(seq 1 $retry_sec); do
     if ssh "$host" hostname; then
         break
     fi
     echo "retry: ssh $host"
     sleep 1
  done
}

# wait for the startup of sshd
for host in $gfmds $gfsds $clients; do
  ssh_retry "$host"
done

for host in $gfmds; do
  cat <<EOF | ssh "$host" sudo sh
set -eux
ln '/etc/grid-security/${host}cert.pem' /etc/grid-security/hostcert.pem
ln '/etc/grid-security/${host}key.pem' /etc/grid-security/hostkey.pem
EOF
done

for host in $gfmds $gfsds $clients; do
  gfservice -d grid-proxy-init "$host"
done

gfservice -k -d config-all

for host in $gfmds; do
  gfservice set-gfmd-conf "$host" digest md5
  gfservice set-gfmd-conf "$host" metadb_server_heartbeat_interval 10
  gfservice restart-gfmd "$host"
  gfservice gfmd-status "$host"
done

for host in $gfsds; do
  gfservice gfsd-status "$host"
done

for host in $clients; do
  gfservice set-gfarm-conf "$host" client_digest_check enable
done

gfmdhost -l
gfhost -lv
num_gfmdhost=$(gfmdhost | wc -l)
num_gfsched=$(gfsched | wc -l)
[ $num_gfmdhost -eq $GFDOCKER_NUM_GFMDS ] || exit 1
[ $num_gfsched -eq $GFDOCKER_NUM_GFSDS ] || exit 1
date
